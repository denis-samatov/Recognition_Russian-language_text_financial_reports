# Recognition_Russian-language_text_financial_reports

## Конвертер PDF в CSV

Этот Python-скрипт предназначен для преобразования файлов PDF и PNG, содержащих таблицы, в формат CSV. Процесс включает в себя следующие этапы:

1. **Преобразование PDF в PNG:**
   - Если входной файл - PDF, скрипт конвертирует каждую страницу PDF в изображение PNG.
   - Если входной файл - PNG, скрипт сразу использует предоставленный файл PNG.

2. **Распознавание таблиц и преобразование в CSV:**
   - Конвертированные файлы PNG обрабатываются для извлечения табличных данных с использованием техник обработки изображений.
   - Извлеченные данные затем записываются в файл CSV.

## Реализация распознавания

Основная идея считывания данных из таблицы заключается в определении координат ее ячеек, благодаря которым можно выделять ячейку отдельно от всего изображения, считывать с неё информацию и записывать полученные данные в файл. Для её реализации в основном будет применяться OpenCV-Python и библиотека Python-Tesseract (PyTesseract), оболочка для Google Tesseract-OCR Engine. Также будут использоваться библиотеки: Matplotlib, CSV. Matplotlib используется для визуализации данных, а CSV для записи распознанной информации в Excel.

### Принцип работы:

1. **Загрузка таблицы:**
   - Входные данные - файлы формата PDF или PNG.
   - Программа обрабатывает только файлы с расширениями PDF и PNG. Если формат не поддерживается, выводится сообщение: "Файл с данным форматом не поддерживается. Используйте PNG или PDF."

2. **Загрузка таблицы и фильтрация изображения:**
   - Для перевода файла из PDF в PNG используется PyMuPDF.
   - Для читения PNG файла применяется функция `cv2.imread()` библиотеки OpenCV.
   - Предварительная обработка изображения включает конвертацию в оттенки серого и адаптивную бинаризацию с использованием OpenCV.

   ```python
   gray = cv2.cvtColor(raw, cv2.COLOR_BGR2GRAY)
   binary = cv2.adaptiveThreshold(~gray, 255, cv2.ADAPTIVE_THRESH_GAUSSIAN_C, cv2.THRESH_BINARY, 35, -5)
   ```

   - Эти шаги выполняются для обеспечения точности распознавания контуров и текста.
     
   ![Таблица](https://github.com/denis-samatov/Recognition_Russian-language_text_financial_reports/blob/main/image_1.png)
   
4. **Определение контуров таблицы:**
   - Результат фильтрации дает двоичное изображение, что позволяет применять морфологические операции.
   - Структурирующий элемент создается для морфологических операций, включая эрозию и расширение.
   - Горизонтальные и вертикальные линии таблицы определяются с использованием этих операций.
   - Пересечение линий определяется побитовой операцией И.

   ```python
   scale = 40
   mask = cv2.getStructuringElement(cv2.MORPH_RECT, (cols // scale, 1))
   eroded = cv2.erode(binary, mask, iterations=1)
   dilated_col = cv2.dilate(eroded, mask, iterations=1) 
   ```

   ```python
   scale = 20
   mask = cv2.getStructuringElement(cv2.MORPH_RECT, (1, rows // scale))
   eroded = cv2.erode(binary, mask, iterations=1) 
   dilated_row = cv2.dilate(eroded, mask, iterations=1)
   ```

   - Результаты представлены на рисунках 13 и 14.

   ![Горизонтальные линии таблицы]([path/to/image13.png](https://github.com/denis-samatov/Recognition_Russian-language_text_financial_reports/blob/main/image_2.png))

   ![Вертикальные линии таблицы](https://github.com/denis-samatov/Recognition_Russian-language_text_financial_reports/blob/main/image_3.png)

   - Координаты пересечений линий определяются и сортируются.

5. **Идентификация координат ячеек:**
   - После определения контуров таблицы можно воспользоваться двоичными операциями для нахождения пересечения вертикальных и горизонтальных линий.
   - Побитовая операция И применяется с использованием функции `cv2.bitwise_and()` для определения белых пересечений на черно-белом изображении.
   - Координаты пересечений определяются с использованием библиотеки NumPy.

   ```python
   bitwise_and = cv2.bitwise_and(dilated_col, dilated_row)
   y_point, x_point = np.where(bitwise_and > 0)
   ```

   - Координаты сортируются для определения точек пересечения.

   ```python
   i = 0
   sort_x_point = np.sort(x_point)
   for i in range(len(sort_x_point) - 1):
       if sort_x_point[i + 1] - sort_x_point[i] > 10:
           x_point_arr.append(sort_x_point[i])
       i = i + 1
   x_point_arr.append(sort_x_point[i])

   i = 0
   sort_y_point = np.sort(y_point)
   for i in range(len(sort_y_point) - 1):
       if (sort_y_point[i + 1] - sort_y_point[i] > 10):
           y_point_arr.append(sort_y_point[i])
       i = i + 1
   y_point_arr.append(sort_y_point[i])
   ```

   - Параметр перехода (в данном случае, 10) может потребовать настройки в зависимости от характеристик таблиц.

## Оценка точности работы программы

Для оценки точности работы программы предлагается сравнивать результаты, полученные программой, с ручным вводом информации. Точность оценивается на основе следующих параметров:

1. **Определение общего количества символов в таблице (n_общ) и количества ошибок (n_ош):**
   - Рассчитываются общее количество символов в таблице и количество ошибок в распознавании.

2. **Расчет точности распознавания по формуле:**
   \[ \eta = \frac{(n_общ - n_ош)}{n_общ} \times 100\% \]

### Проведение исследования точности

Исследование точности проводится на данных, собранных из методического материала "Анализ финансово-хозяйственной деятельности". Несколько попыток распознавания были проведены с увеличением числа страниц. Помимо точности распознавания, рассчитывается время распознавания одной страницы с таблицей (\(t_стр\)), которое вычисляется по формуле:

\[ t_стр = \frac{t_общ}{N} \]

где \(N\) – число распознанных страниц с таблицей, \(t_общ\) – общее время распознавания всех страниц.

![Замеры точности]([path/to/image14.png](https://github.com/denis-samatov/Recognition_Russian-language_text_financial_reports/blob/main/image_5.png))
   
### Примерный порядок действий:

1. **Подготовка данных:**
   - Подготовьте набор тестовых данных с таблицами для распознавания.
   - Выполните ручной ввод информации из этих таблиц.

2. **Запуск программы:**
   - Запустите программу на подготовленных тестовых данных.

3. **Оценка точности:**
   - Посчитайте общее количество символов (\(n_общ\)) и количество ошибок (\(n_ош\)).
   - Рассчитайте точность распознавания по формуле \(\eta\).

4. **Измерение времени:**
   - Измерьте общее время распознавания всех страниц (\(t_общ\)).
   - Рассчитайте среднее время распознавания одной страницы (\(t_стр\)).

### Дополнительные рекомендации:

- Повторите исследование на различных типах таблиц и с разными характеристиками для более всесторонней оценки точности.

### Зависимости

- Убедитесь, что библиотеки, указанные в разделе "Зависимости", установлены для корректной работы программы.

### Отказ от ответственности

Результаты оценки точности могут зависеть от характера таблиц и специфики данных. Рекомендуется внимательно проверить созданные CSV файлы на точность распознавания перед проведением оценки.
### Дополнительные замечания:

- Важно настроить параметры предварительной обработки изображения в соответствии с характеристиками ваших таблиц.

## Зависимости

- Подробная информация о библиотеках и их использовании указана в предыдущей секции "Зависимости".

## Отказ от ответственности

Этот скрипт предоставляется "как есть". Результаты работы могут зависеть от характера и сложности таблиц во входных файлах. Перед использованием рекомендуется внимательно проверить созданные CSV файлы на точность распознавания.
